name: Build PDFs from Markdown (recursive)

on:
  workflow_dispatch:
    inputs:
      include_root:
        description: "Generate root.pdf (includes ALL markdown recursively)"
        required: false
        default: "true"
      output_dir:
        description: "Output folder at repo root"
        required: false
        default: "generated-pdf"
      commit_back:
        description: "Commit generated PDFs back to the repository"
        required: false
        default: "false"
      pdf_engine:
        description: "PDF engine (xelatex recommended)"
        required: false
        default: "xelatex"

  push:
    branches: ["main"]
    paths-ignore:
      - "generated-pdf/**"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build PDFs (Pandoc + LaTeX container)
        env:
          INCLUDE_ROOT: ${{ github.event.inputs.include_root || 'true' }}
          OUTPUT_DIR: ${{ github.event.inputs.output_dir || 'generated-pdf' }}
          COMMIT_BACK: ${{ github.event.inputs.commit_back || 'false' }}
          PDF_ENGINE: ${{ github.event.inputs.pdf_engine || 'xelatex' }}
        run: |
          set -eu

          echo "INCLUDE_ROOT=$INCLUDE_ROOT"
          echo "OUTPUT_DIR=$OUTPUT_DIR"
          echo "PDF_ENGINE=$PDF_ENGINE"
          echo "COMMIT_BACK=$COMMIT_BACK"

          # Use pandoc/latex for PDF output (Pandoc + LaTeX toolchain) [1](https://github.com/pandoc/pandoc-action-example)[2](http://pandoc.org/MANUAL.html)
          # IMPORTANT: override entrypoint so '-lc' is interpreted by /bin/sh, not by pandoc.
          docker run --rm \
            --entrypoint /bin/sh \
            -v "${GITHUB_WORKSPACE}:/data" \
            -w /data \
            -e INCLUDE_ROOT="${INCLUDE_ROOT}" \
            -e OUTPUT_DIR="${OUTPUT_DIR}" \
            -e PDF_ENGINE="${PDF_ENGINE}" \
            pandoc/latex:3.8 \
            -lc '
              set -eu

              OUTPUT_DIR="${OUTPUT_DIR:-generated-pdf}"
              INCLUDE_ROOT="${INCLUDE_ROOT:-true}"
              PDF_ENGINE="${PDF_ENGINE:-xelatex}"

              mkdir -p "$OUTPUT_DIR"

              # Exclude common directories + output dir (generalized)
              EX1="*/.git/*"
              EX2="*/.github/*"
              EX3="*/node_modules/*"
              EX4="*/dist/*"
              EX5="*/build/*"
              EX6="*/target/*"
              EX7="*/vendor/*"
              EX8="*/${OUTPUT_DIR}/*"

              collect_md() {
                base="$1"
                find "$base" -type f -name "*.md" \
                  ! -path "$EX1" ! -path "$EX2" ! -path "$EX3" ! -path "$EX4" \
                  ! -path "$EX5" ! -path "$EX6" ! -path "$EX7" ! -path "$EX8" \
                  | LC_ALL=C sort
              }

              # Pandoc image resolution often needs --resource-path when images are not in CWD. [3](https://stackoverflow.com/questions/74685574/image-file-path-error-while-using-pandoc-for-markdown-to-pdf-conversion)[4](https://github.com/jgm/pandoc/discussions/9315)
              build_resource_path_from_listfile() {
                listfile="$1"
                {
                  echo "."
                  while IFS= read -r f; do
                    dirname "$f"
                  done < "$listfile"
                } | awk "!seen[\$0]++ { out = (out==\"\" ? \$0 : out\":\"\$0) } END { print out }"
              }

              # Inject a top-level heading before each file => PDF outline/bookmarks in many viewers. [5](https://learnbyexample.github.io/customizing-pandoc/)
              build_combined_md() {
                base="$1"
                listfile="$2"
                tmpmd="$3"

