name: Build PDFs from Markdown (folders + optional root)

on:
  workflow_dispatch:
    inputs:
      include_root:
        description: "Also generate a single PDF for the repository root (includes ALL markdown recursively)"
        required: false
        default: "true"
      output_dir:
        description: "Output folder at repo root"
        required: false
        default: "generated-pdf"
      commit_back:
        description: "Commit generated PDFs back to the repository"
        required: false
        default: "false"
      pdf_engine:
        description: "PDF engine (xelatex recommended for Unicode/fonts)"
        required: false
        default: "xelatex"
  push:
    branches: ["main"]
    paths-ignore:
      - "generated-pdf/**"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate PDFs (Pandoc in Docker)
        env:
          INCLUDE_ROOT: ${{ inputs.include_root || 'true' }}
          OUTPUT_DIR: ${{ inputs.output_dir || 'generated-pdf' }}
          COMMIT_BACK: ${{ inputs.commit_back || 'false' }}
          PDF_ENGINE: ${{ inputs.pdf_engine || 'xelatex' }}
        run: |
          set -euo pipefail

          echo "INCLUDE_ROOT=${INCLUDE_ROOT}"
          echo "OUTPUT_DIR=${OUTPUT_DIR}"
          echo "PDF_ENGINE=${PDF_ENGINE}"

          # Run inside pandoc/latex container (includes LaTeX needed for PDF output) [2](https://github.com/pandoc/pandoc-action-example)
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/data" \
            -w /data \
            -e INCLUDE_ROOT="${INCLUDE_ROOT}" \
            -e OUTPUT_DIR="${OUTPUT_DIR}" \
            -e PDF_ENGINE="${PDF_ENGINE}" \
            pandoc/latex:3.8 \
            /bin/sh -lc '
              set -euo pipefail

              # Install tools we rely on (bash, findutils, coreutils)
              # pandoc/latex images vary; this makes the script robust.
              if command -v apk >/dev/null 2>&1; then
                apk add --no-cache bash coreutils findutils >/dev/null
              elif command -v apt-get >/dev/null 2>&1; then
                apt-get update -y >/dev/null
                apt-get install -y bash coreutils findutils >/dev/null
              fi

              bash -lc "
                set -euo pipefail

                OUTPUT_DIR=\${OUTPUT_DIR:-generated-pdf}
                INCLUDE_ROOT=\${INCLUDE_ROOT:-true}
                PDF_ENGINE=\${PDF_ENGINE:-xelatex}

                # Exclusions (common repo folders + the output folder itself)
                # You can extend this list for any repo.
                EXCLUDE_DIRS=(.git .github node_modules dist build target vendor \${OUTPUT_DIR})

                mkdir -p \"\${OUTPUT_DIR}\"

                # Helper: build a find prune expression from EXCLUDE_DIRS
                build_prune_args() {
                  local args=()
                  for d in \"\${EXCLUDE_DIRS[@]}\"; do
                    args+=( -path \"./\${d}\" -o -path \"./\${d}/*\" -o )
                  done
                  # remove trailing -o
                  unset \"args[\${#args[@]}-1]\"
                  echo \"\${args[@]}\"
                }

                PRUNE_ARGS=\$(build_prune_args)

                # Helper: collect markdown files under a directory (recursive), excluding pruned dirs
                # Sorted for deterministic output ordering.
                collect_md_files() {
                  local base=\"\$1\"
                  if [[ \"\$base\" == \".\" ]]; then
                    # All repo markdown
                    eval find . \\( \$PRUNE_ARGS \\) -prune -o -type f -name \"*.md\" -print | sort
                  else
                    # Under subfolder (recursive)
                    eval find \"\$base\" \\( \$PRUNE_ARGS \\) -prune -o -type f -name \"*.md\" -print | sort
                  fi
                }

                # Helper: create a robust resource path list (colon-separated) for pandoc images.
                # Pandoc often needs --resource-path when images aren't in the working dir. [3](https://stackoverflow.com/questions/74685574/image-file-path-error-while-using-pandoc-for-markdown-to-pdf-conversion)[4](https://github.com/jgm/pandoc/discussions/9315)
                build_resource_path() {
                  local files=(\"\$@\")
                  local dirs=(\".\")

                  for f in \"\${files[@]}\"; do
                    dirs+=(\"\$(dirname \"\$f\")\")
                  done

                  # unique directories
                  local uniq=()
                  local seen=\"\"
                  for d in \"\${dirs[@]}\"; do
                    if [[ \";\$seen;\" != *\";\$d;\"* ]]; then
                      uniq+=(\"\$d\")
                      seen+=\"\$d;\"
                    fi
                  done

                  (IFS=:; echo \"\${uniq[*]}\")
                }

                # Helper: safe title from a folder name
                folder_title() {
                  local p=\"\$1\"
                  [[ \"\$p\" == \".\" ]] && echo \"root\" || basename \"\$p\"
                }

                # Helper: build a single combined markdown with a top-level heading before each file
                # This ensures PDF bookmarks per file (headings become outline entries in many viewers). [5](https://learnbyexample.github.io/customizing-pandoc/)
                build_combined_md() {
                  local base_dir=\"\$1\"
                  shift
                  local files=(\"\$@\")
                  local tmp=\"\$(mktemp)\"

                  {
                    echo \"% Auto-generated by GitHub Actions\"
                    echo \"# \$(folder_title \"\$base_dir\")\"
                    echo

                    for f in \"\${files[@]}\"; do
                      # Relative label (nice bookmark text)
                      local label=\"\$f\"
                      if [[ \"\$base_dir\" != \".\" ]]; then
                        # make path relative to folder pdf root
                        label=\"\${f#\$base_dir/}\"
                      else
                        label=\"\${f#./}\"
                      fi

                      echo \"# \${label}\"
                      echo
                      cat \"\$f\"
                      echo -e \"\\n\\n\"
                    done
                  } > \"\$tmp\"

                  echo \"\$tmp\"
                }

                # Build one PDF per FIRST-LEVEL directory, recursively including nested markdown files
                # (Your requested behavior: nested .md included, output named after sub-folder)
                shopt -s nullglob
                for dir in */ ; do
                  dir=\"\${dir%/}\"

                  # Skip excluded directories
                  skip=false
                  for ex in \"\${EXCLUDE_DIRS[@]}\"; do
                    [[ \"\$dir\" == \"\$ex\" ]] && skip=true && break
                  done
                  \$skip && continue

                  mapfile -t files < <(collect_md_files \"\$dir\")
                  [[ \${#files[@]} -eq 0 ]] && continue

                  res_path=\$(build_resource_path \"\${files[@]}\")
                  tmp_md=\$(build_combined_md \"\$dir\" \"\${files[@]}\")
                  out_pdf=\"\${OUTPUT_DIR}/\${dir}.pdf\"

                  echo \"==> Building \${out_pdf} (files: \${#files[@]})\"

                  # pandoc combines inputs into a single output document [1](http://pandoc.org/MANUAL.html)
                  pandoc --from gfm \
                         --standalone \
                         --toc \
                         --pdf-engine=\"\$PDF_ENGINE\" \
                         --metadata title=\"\$dir\" \
                         --resource-path=\"\$res_path\" \
                         -o \"\$out_pdf\" \
                         \"\$tmp_md\"

                  rm -f \"\$tmp_md\"
                done

                # Optional: root PDF (includes ALL markdown recursively)
                if [[ \"\$INCLUDE_ROOT\" == \"true\" || \"\$INCLUDE_ROOT\" == \"True\" || \"\$INCLUDE_ROOT\" == \"1\" ]]; then
                  mapfile -t root_files < <(collect_md_files \".\")
                  if [[ \${#root_files[@]} -gt 0 ]]; then
                    res_path=\$(build_resource_path \"\${root_files[@]}\")
                    tmp_md=\$(build_combined_md \".\" \"\${root_files[@]}\")
                    out_pdf=\"\${OUTPUT_DIR}/root.pdf\"

                    echo \"==> Building \${out_pdf} (files: \${#root_files[@]})\"

                    pandoc --from gfm \
                           --standalone \
                           --toc \
                           --pdf-engine=\"\$PDF_ENGINE\" \
                           --metadata title=\"root\" \
                           --resource-path=\"\$res_path\" \
                           -o \"\$out_pdf\" \
                           \"\$tmp_md\"

                    rm -f \"\$tmp_md\"
                  else
                    echo \"No markdown files found for root PDF.\"
                  fi
                fi

                echo
                echo \"Generated PDFs:\"
                ls -lah \"\${OUTPUT_DIR}\" || true
              "
            '

      - name: Upload PDFs as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-pdfs
          path: ${{ inputs.output_dir || 'generated-pdf' }}/

      - name: Commit generated PDFs back to repo (optional)
        if: ${{ (inputs.commit_back || 'false') == 'true' }}
        run: |
          set -euo pipefail
          OUT="${{ inputs.output_dir || 'generated-pdf' }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Avoid infinite rebuild loops by ignoring output path in triggers (already set in paths-ignore)
          if [[ -n "$(git status --porcelain "$OUT")" ]]; then
            git add "$OUT"
            git commit -m "chore: update generated PDFs"
            git push
          else
            echo "No changes in $OUT to commit."
          fi
