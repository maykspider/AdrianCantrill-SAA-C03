name: Convert Markdown to PDF (per file)

on:
  workflow_dispatch:
    inputs:
      root_dir:
        description: "Root folder to scan for Markdown files (use '.' for repo root)"
        required: true
        default: "."
      output_dir:
        description: "Folder to store generated PDFs (artifact will contain this)"
        required: true
        default: "pdfs"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install md-to-pdf
        run: npm i -g md-to-pdf

      - name: Convert each .md to .pdf (preserve names + folder structure)
        shell: bash
        run: |
          set -euo pipefail

          ROOT="${{ inputs.root_dir }}"
          OUT="${{ inputs.output_dir }}"

          if [[ ! -d "$ROOT" ]]; then
            echo "Root directory '$ROOT' not found."
            echo "Tip: If your Markdown files are at repo root, use root_dir='.'."
            exit 1
          fi

          mkdir -p "$OUT"

          echo "Scanning for .md files under: $ROOT"
          count=0

          # Find all markdown files recursively
          while IFS= read -r -d '' file; do
            count=$((count+1))
            dir="$(dirname "$file")"
            base="$(basename "$file" .md)"

            # Compute path relative to ROOT to preserve structure in OUT
            rel_dir="${dir#"$ROOT"/}"
            if [[ "$dir" == "$ROOT" || "$ROOT" == "." ]]; then
              # If ROOT is '.' then keep rel_dir as the actual dir relative to repo
              if [[ "$ROOT" == "." ]]; then
                rel_dir="${dir#./}"
              else
                rel_dir="."
              fi
            fi

            out_sub="$OUT/$rel_dir"
            mkdir -p "$out_sub"

            echo "[$count] Converting: $file"

            # IMPORTANT:
            # md-to-pdf generates the PDF next to the source file by default. [1](https://elephas.app/blog/notebooklm-source-limits)
            # We run it from the file's directory so relative assets resolve naturally.
            (
              cd "$dir"
              md-to-pdf "$(basename "$file")" --basedir "$dir"
            )

            # Move the generated PDF into output directory preserving structure
            if [[ -f "$dir/$base.pdf" ]]; then
              mv "$dir/$base.pdf" "$out_sub/$base.pdf"
            else
              echo "ERROR: Expected PDF was not generated for $file"
              exit 1
            fi
          done < <(find "$ROOT" -type f -name '*.md' -print0)

          echo "Converted $count Markdown file(s)."
          echo "PDF output folder: $OUT"
          echo "Listing generated PDFs:"
          find "$OUT" -type f -name '*.pdf' -print -exec ls -lh {} \;

      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdfs-per-file
          path: ${{ inputs.output_dir }}
